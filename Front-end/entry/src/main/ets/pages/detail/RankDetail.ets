import { RankSongModel, UserClickModel, Consumer, SongModel } from '../model/AppModel'
import { getSongsRanking, getUserClicks, getSongs } from '../common/Api'
import { dayModel, nightModel, ColorModel } from "../model/ColorModel"
import router from '@ohos.router'
import promptAction from '@ohos.promptAction'
import preferencesUtil from '../common/PreferencesUtil'
import { ConfigUtil } from '../common/ConfigUtil'

@Entry
@Component
export struct Rank {
  @StorageLink("isDark") isDark: boolean = false
  @StorageLink("myColor") myColor: ColorModel = (this.isDark == true ? nightModel : dayModel)
  @StorageLink("isLoggedIn") isLoggedIn: boolean = false
  @StorageLink("currentUser") currentUser: Consumer | null = null

  @State currentTab: number = 0 // 0: çƒ­åº¦æ¦œå•, 1: æˆ‘çš„æ¦œå•
  @State songsRanking: RankSongModel[] = []
  @State userClicks: UserClickModel[] = []
  @State allSongs: SongModel[] = []
  @State isLoading: boolean = false

  async aboutToAppear() {
    await this.initializeUserState()
    await this.getAllSongs()
    await this.getSongsRankingData()
    if (this.isLoggedIn && this.currentUser) {
      await this.getUserClicksData()
    }
  }

  // åˆå§‹åŒ–ç”¨æˆ·çŠ¶æ€
  async initializeUserState() {
    try {
      const token = await preferencesUtil.get("userinfoStore", "token", "") as string
      const userInfoStr = await preferencesUtil.get("userinfoStore", "userInfo", "") as string
      const isLoggedIn = await preferencesUtil.get("userinfoStore", "isLoggedIn", false) as boolean

      if (token && userInfoStr && isLoggedIn) {
        // ç”¨æˆ·å·²ç™»å½•ï¼Œæ¢å¤ç™»å½•çŠ¶æ€
        const userInfo = JSON.parse(userInfoStr) as Consumer
        this.restoreLoggedInState(userInfo, token)
      } else {
        // ç¡®ä¿æœªç™»å½•çŠ¶æ€
        this.resetToLoggedOutState()
      }
    } catch (error) {
      console.error('åˆå§‹åŒ–ç”¨æˆ·çŠ¶æ€å¤±è´¥:', error)
    }
  }

  // æ¢å¤ç™»å½•çŠ¶æ€
  private restoreLoggedInState(userInfo: Consumer, token: string) {
    this.isLoggedIn = true
    this.currentUser = userInfo

    // åŒæ­¥æŒä¹…åŒ–å­˜å‚¨
    PersistentStorage.PersistProp('isLoggedIn', true)
    PersistentStorage.PersistProp('userToken', token)
    PersistentStorage.PersistProp('currentUser', userInfo)
  }

  // é‡ç½®ä¸ºæœªç™»å½•çŠ¶æ€
  private resetToLoggedOutState() {
    this.isLoggedIn = false
    this.currentUser = null

    // æ¸…é™¤æŒä¹…åŒ–å­˜å‚¨
    PersistentStorage.PersistProp('isLoggedIn', false)
    PersistentStorage.PersistProp('userToken', '')
    PersistentStorage.PersistProp('currentUser', null)
  }

  // è·å–æ‰€æœ‰æ­Œæ›²ä¿¡æ¯
  async getAllSongs() {
    try {
      const res = await getSongs()
      if (res.success) {
        this.allSongs = res.data as SongModel[]
      }
    } catch (error) {
      console.error('è·å–æ­Œæ›²ä¿¡æ¯å¤±è´¥:', error)
    }
  }

  // è·å–æ­Œæ›²çƒ­åº¦æ’è¡Œæ¦œ
  async getSongsRankingData() {
    try {
      this.isLoading = true
      const res = await getSongsRanking()
      if (res.success) {
        this.songsRanking = res.data as RankSongModel[]
      } else {
        promptAction.showToast({ message: res.message || 'è·å–çƒ­åº¦æ¦œå•å¤±è´¥' })
      }
    } catch (error) {
      console.error('è·å–çƒ­åº¦æ¦œå•å¤±è´¥:', error)
      promptAction.showToast({ message: 'è·å–çƒ­åº¦æ¦œå•å¤±è´¥' })
    } finally {
      this.isLoading = false
    }
  }

  // è·å–ç”¨æˆ·ç‚¹å‡»æ’è¡Œæ¦œ
  async getUserClicksData() {
    try {
      if (!this.currentUser?.id) return

      this.isLoading = true
      const res = await getUserClicks(this.currentUser.id)
      if (res.success) {
        this.userClicks = res.data as UserClickModel[]
      } else {
        promptAction.showToast({ message: res.message || 'è·å–æˆ‘çš„æ¦œå•å¤±è´¥' })
      }
    } catch (error) {
      console.error('è·å–æˆ‘çš„æ¦œå•å¤±è´¥:', error)
      promptAction.showToast({ message: 'è·å–æˆ‘çš„æ¦œå•å¤±è´¥' })
    } finally {
      this.isLoading = false
    }
  }

  // è·å–ç”¨æˆ·å¤´åƒURL
  getUserAvatarUrl(avatar?: string): string {
    if (!avatar) return ''
    return `${ConfigUtil.SERVERURL}consumer/${avatar}`
  }

  // è·å–æ­Œæ›²å›¾ç‰‡URL
  getSongImageUrl(songName: string): string {
    if (!songName) return ''
    return `${ConfigUtil.SERVERURL}song/${songName}.jpg`
  }

  // æ ¹æ®æ­Œæ›²IDè·å–æ­Œæ›²ä¿¡æ¯
  getSongById(songId: number): SongModel | null {
    return this.allSongs.find(song => song.id === songId) || null
  }

  // æ’­æ”¾æ­Œæ›²
  playSong(songId: number) {
    router.pushUrl({
      url: 'pages/Player',
      params: { songId: songId }
    })
  }

  // æ ‡ç­¾é¡µåˆ‡æ¢ç»„ä»¶
  @Builder
  TabBar() {
    Row() {
      // çƒ­åº¦æ¦œå•
      Column({space:5}) {
        Text('çƒ­åº¦æ¦œå•')
          .fontSize(16)
          .fontColor(this.currentTab === 0 ? this.myColor.dark : this.myColor.gray)
          .fontWeight(this.currentTab === 0 ? FontWeight.Bold : FontWeight.Normal)

        if (this.currentTab === 0) {
          Image($r('app.media.line'))
            .fillColor("#03e884")
            .width(70)
            .height(3)
        }
      }
      .width('50%')
      .padding({ top: 15, bottom: 15 })
      .onClick(() => {
        this.currentTab = 0
      })

      // æˆ‘çš„æ¦œå•
      Column() {
        Text('æˆ‘çš„æ¦œå•')
          .fontSize(16)
          .fontColor(this.currentTab === 1 ? this.myColor.dark : this.myColor.gray)
          .fontWeight(this.currentTab === 1 ? FontWeight.Bold : FontWeight.Normal)

        if (this.currentTab === 1) {
          Image($r('app.media.line'))
            .fillColor("#03e884")
            .width(70)
            .height(3)
        }
      }
      .width('50%')
      .padding({ top: 15, bottom: 15 })
      .onClick(() => {
        if (!this.isLoggedIn) {
          promptAction.showToast({ message: 'è¯·å…ˆç™»å½•' })
          return
        }
        this.currentTab = 1
        if (this.userClicks.length === 0) {
          this.getUserClicksData()
        }
      })
    }
    .height(50)
    .width('100%')
    .backgroundColor(this.myColor.bright)
    .justifyContent(FlexAlign.SpaceAround)
  }

  // æ’åå›¾æ ‡ç»„ä»¶
  @Builder
  RankIcon(rank: number) {
    if (rank < 3) {
      Stack() {
        Circle()
          .width(36)
          .height(36)
          .fill(rank === 0 ? '#FFD700' : rank === 1 ? '#C0C0C0' : '#CD7F32')

        Text((rank + 1).toString())
          .fontSize(16)
          .fontColor(Color.White)
          .fontWeight(FontWeight.Bold)
      }
    } else {
      Stack() {
        Circle()
          .width(36)
          .height(36)
          .fill(this.myColor.bright)
          .border({
            width: 2,
            color: this.myColor.gray,
            radius: 18
          })

        Text((rank + 1).toString())
          .fontSize(16)
          .fontColor(this.myColor.dark)
          .fontWeight(FontWeight.Bold)
      }
    }
  }

  // æ’è¡Œæ¦œé¡¹ç›®ç»„ä»¶
  @Builder
  RankItem(rank: number, song: RankSongModel, clickNum: number) {
    Row() {
      // æ’å
      this.RankIcon(rank)

      // æ­Œæ›²å°é¢
      Image(this.getSongImageUrl(song.name) || $r('app.media.img'))
        .width(60)
        .height(60)
        .borderRadius(12)
        .margin({ left: 20, right: 16 })
        .alt($r('app.media.img'))
        .shadow({
          radius: 8,
          color: '#00000015',
          offsetX: 0,
          offsetY: 2
        })

      // æ­Œæ›²ä¿¡æ¯
      Column() {
        Text(song.name)
          .fontSize(17)
          .fontColor(this.myColor.dark)
          .fontWeight(FontWeight.Medium)
          .maxLines(1)
          .textOverflow({ overflow: TextOverflow.Ellipsis })

        Text(song.singer || 'æœªçŸ¥æ­Œæ‰‹')
          .fontSize(14)
          .fontColor(this.myColor.gray)
          .margin({ top: 6 })
          .maxLines(1)
          .textOverflow({ overflow: TextOverflow.Ellipsis })

        if (song.album) {
          Text(song.album)
            .fontSize(12)
            .fontColor(this.myColor.gray)
            .opacity(0.7)
            .margin({ top: 4 })
            .maxLines(1)
            .textOverflow({ overflow: TextOverflow.Ellipsis })
        }
      }
      .alignItems(HorizontalAlign.Start)
      .layoutWeight(1)

      // æ’­æ”¾æ¬¡æ•°
      Column() {
        Text(clickNum.toString())
          .fontSize(18)
          .fontColor(this.myColor.dark)
          .fontWeight(FontWeight.Bold)

        Text('æ’­æ”¾')
          .fontSize(12)
          .fontColor(this.myColor.gray)
          .margin({ top: 2 })
      }
      .alignItems(HorizontalAlign.Center)
      .margin({ right: 16 })

      // æ’­æ”¾æŒ‰é’®
      Stack() {
        Circle()
          .width(36)
          .height(36)
          .fill(this.myColor.bright)
          .border({
            width: 2,
            color: this.myColor.dark,
            radius: 18
          })

        Image($r('app.media.play_icon'))
          .width(20)
          .height(20)
          .fillColor(this.myColor.dark)
          .margin({left:4})
      }
      .margin({ right: 15 })
    }
    .width('100%')
    .padding({ left: 16, right: 16, top: 16, bottom: 16 })
    .backgroundColor(this.myColor.bright)
    .borderRadius(16)
    .margin({ left: 16, right: 16, bottom: 12 })
    .shadow({
      radius: 8,
      color: '#00000008',
      offsetX: 0,
      offsetY: 2
    })
    .onClick(() => {
      this.playSong(song.id)
    })
  }

  // ç”¨æˆ·ç‚¹å‡»æ’è¡Œæ¦œé¡¹ç›®ç»„ä»¶
  @Builder
  UserClickItem(rank: number, userClick: UserClickModel) {
    Row() {
      // æ’å
      this.RankIcon(rank)

      // æ­Œæ›²å°é¢
      Image(this.getSongById(userClick.song_id)?.name ?
      this.getSongImageUrl(this.getSongById(userClick.song_id)!.name) :
      $r('app.media.img'))
        .width(60)
        .height(60)
        .borderRadius(12)
        .margin({ left: 20, right: 16 })
        .alt($r('app.media.img'))
        .shadow({
          radius: 8,
          color: '#00000015',
          offsetX: 0,
          offsetY: 2
        })

      // æ­Œæ›²ä¿¡æ¯
      Column() {
        Text(this.getSongById(userClick.song_id)?.name || 'æœªçŸ¥æ­Œæ›²')
          .fontSize(17)
          .fontColor(this.myColor.dark)
          .fontWeight(FontWeight.Medium)
          .maxLines(1)
          .textOverflow({ overflow: TextOverflow.Ellipsis })

        Text(this.getSongById(userClick.song_id)?.singer || 'æœªçŸ¥æ­Œæ‰‹')
          .fontSize(14)
          .fontColor(this.myColor.gray)
          .margin({ top: 6 })
          .maxLines(1)
          .textOverflow({ overflow: TextOverflow.Ellipsis })

        if (this.getSongById(userClick.song_id)?.album) {
          Text(this.getSongById(userClick.song_id)!.album!)
            .fontSize(12)
            .fontColor(this.myColor.gray)
            .opacity(0.7)
            .margin({ top: 4 })
            .maxLines(1)
            .textOverflow({ overflow: TextOverflow.Ellipsis })
        }
      }
      .alignItems(HorizontalAlign.Start)
      .layoutWeight(1)

      // ç‚¹å‡»æ¬¡æ•°
      Column() {
        Text(userClick.click_num.toString())
          .fontSize(18)
          .fontColor(this.myColor.dark)
          .fontWeight(FontWeight.Bold)

        Text('ç‚¹å‡»')
          .fontSize(12)
          .fontColor(this.myColor.gray)
          .margin({ top: 2 })
      }
      .alignItems(HorizontalAlign.Center)
      .margin({ right: 16 })

      // æ’­æ”¾æŒ‰é’®
      Stack() {
        Circle()
          .width(36)
          .height(36)
          .fill(this.myColor.bright)
          .border({
            width: 2,
            color: this.myColor.dark,
            radius: 18
          })

        Image($r('app.media.play_icon'))
          .width(20)
          .height(20)
          .fillColor(this.myColor.dark)
          .margin({left:4})
      }
      .margin({ right: 15 })
    }
    .width('100%')
    .padding({ left: 16, right: 16, top: 16, bottom: 16 })
    .backgroundColor(this.myColor.bright)
    .borderRadius(16)
    .margin({ left: 16, right: 16, bottom: 12 })
    .shadow({
      radius: 8,
      color: '#00000008',
      offsetX: 0,
      offsetY: 2
    })
    .onClick(() => {
      this.playSong(userClick.song_id)
    })
  }

  build() {
    Column() {
      // é¡µé¢æ ‡é¢˜
      Row() {
        Column({space:5}) {
          Text('æ’è¡Œæ¦œ')
            .fontSize(24)
            .fontColor(this.myColor.dark)
            .fontWeight(FontWeight.Bold)
            .margin({ left: 20 })
            .width(90)
          Image($r('app.media.line'))
            .fillColor("#03e884")
            .width(70)
            .height(3)
        }
        .alignItems(HorizontalAlign.Center)
        .justifyContent(FlexAlign.Start)
      }
      .width('100%')
      .padding({ top: 20 , bottom: 10})
      .backgroundColor(this.myColor.background)
      .justifyContent(FlexAlign.Start)

      // æ ‡ç­¾é¡µ
      this.TabBar()

      Divider()
        .color(this.myColor.gray)
        .opacity(0.2)

      // å†…å®¹åŒºåŸŸ
      if (this.isLoading) {
        Column() {
          LoadingProgress()
            .width(50)
            .height(50)
            .color('#4CAF50')

          Text('åŠ è½½ä¸­...')
            .fontSize(16)
            .fontColor(this.myColor.gray)
            .margin({ top: 15 })
        }
        .width('100%')
        .layoutWeight(1)
        .justifyContent(FlexAlign.Center)
        .alignItems(HorizontalAlign.Center)
        .backgroundColor(this.myColor.background)
      } else {
        if (this.currentTab === 0) {
          // çƒ­åº¦æ¦œå•
          if (this.songsRanking.length > 0) {
            Column() {
              // æ¦œå•å¤´éƒ¨ä¿¡æ¯
              Row() {
                Column() {
                  Text(`çƒ­åº¦æ¦œå•`)
                    .fontSize(20)
                    .fontColor(this.myColor.dark)
                    .fontWeight(FontWeight.Bold)

                  Text(`å…± ${this.songsRanking.length} é¦–æ­Œæ›²`)
                    .fontSize(14)
                    .fontColor(this.myColor.gray)
                    .margin({ top: 4 })
                }
                .alignItems(HorizontalAlign.Start)
                .layoutWeight(1)

                // çƒ­åº¦å›¾æ ‡
                Stack() {
                  Circle()
                    .width(44)
                    .height(44)
                    .fill('#ffe2decf')

                  Text('ğŸ”¥')
                    .fontSize(24)
                }
              }
              .width('100%')
              .padding({ left: 20, right: 20, top: 16, bottom: 16 })
              .backgroundColor(this.myColor.bright)
              .borderRadius(16)
              .margin({top:8, left: 16, right: 16, bottom: 8 })

              List({ space: 0 }) {
                ForEach(this.songsRanking, (rankSong: RankSongModel, index: number) => {
                  ListItem() {
                    this.RankItem(index, rankSong, rankSong.click_num)
                  }
                })
              }
              .width('100%')
              .layoutWeight(1)
              .scrollBar(BarState.Auto)
              .backgroundColor(this.myColor.background)
            }
            .width('100%')
            .layoutWeight(1)
            .backgroundColor(this.myColor.background)
          } else {
            Column() {
              Stack() {
                Circle()
                  .width(120)
                  .height(120)
                  .fill(this.myColor.bright)
                  .border({
                    width: 2,
                    color: this.myColor.gray,
                    style: BorderStyle.Dashed
                  })

                Text('ğŸ“Š')
                  .fontSize(48)
              }

              Text('æš‚æ— çƒ­åº¦æ¦œå•')
                .fontSize(18)
                .fontColor(this.myColor.dark)
                .fontWeight(FontWeight.Medium)
                .margin({ top: 24 })

              Text('ç¨åå†æ¥çœ‹çœ‹å§')
                .fontSize(14)
                .fontColor(this.myColor.gray)
                .opacity(0.8)
                .margin({ top: 8 })
            }
            .width('100%')
            .layoutWeight(1)
            .justifyContent(FlexAlign.Center)
            .alignItems(HorizontalAlign.Center)
            .backgroundColor(this.myColor.background)
          }
        } else {
          // æˆ‘çš„æ¦œå•
          if (!this.isLoggedIn) {
            Column() {
              Stack() {
                Circle()
                  .width(120)
                  .height(120)
                  .fill(this.myColor.bright)
                  .border({
                    width: 2,
                    color: '#4CAF50',
                    style: BorderStyle.Dashed
                  })

                Text('ğŸ”')
                  .fontSize(48)
              }

              Text('è¯·å…ˆç™»å½•')
                .fontSize(20)
                .fontColor(this.myColor.dark)
                .fontWeight(FontWeight.Bold)
                .margin({ top: 24 })

              Text('ç™»å½•åæŸ¥çœ‹æ‚¨çš„ä¸ªäººç‚¹å‡»æ¦œå•')
                .fontSize(14)
                .fontColor(this.myColor.gray)
                .opacity(0.8)
                .margin({ top: 8 })
                .textAlign(TextAlign.Center)

              Button('å»ç™»å½•')
                .backgroundColor('#4CAF50')
                .fontColor(Color.White)
                .borderRadius(25)
                .margin({ top: 32 })
                .padding({ left: 32, right: 32, top: 12, bottom: 12 })
                .shadow({
                  radius: 8,
                  color: '#4CAF5030',
                  offsetX: 0,
                  offsetY: 4
                })
                .onClick(() => {
                  // æç¤ºç”¨æˆ·åˆ°"æˆ‘çš„"é¡µé¢ç™»å½•
                  promptAction.showToast({ message: 'è¯·åˆ°"æˆ‘çš„"é¡µé¢è¿›è¡Œç™»å½•' })
                })
            }
            .width('100%')
            .layoutWeight(1)
            .justifyContent(FlexAlign.Center)
            .alignItems(HorizontalAlign.Center)
            .backgroundColor(this.myColor.background)
            .padding({ left: 40, right: 40 })
          } else if (this.userClicks.length > 0) {
            Column() {
              // æ¦œå•å¤´éƒ¨ä¿¡æ¯
              Row() {
                // ç”¨æˆ·å¤´åƒ
                Image(this.currentUser?.avatar ?
                this.getUserAvatarUrl(this.currentUser.avatar) :
                $r('app.media.profile'))
                  .width(44)
                  .height(44)
                  .borderRadius(22)
                  .alt($r('app.media.profile'))
                  .margin({ right: 12 })

                Column() {
                  Row() {
                    Text(`${this.currentUser?.username || 'ç”¨æˆ·'} çš„æ¦œå•`)
                      .fontSize(20)
                      .fontColor(this.myColor.dark)
                      .fontWeight(FontWeight.Bold)

                    Text('ğŸ–ï¸')
                      .fontSize(16)
                      .margin({ left: 8 })
                  }

                  Text(`å…± ${this.userClicks.length} é¦–æ­Œæ›²`)
                    .fontSize(14)
                    .fontColor(this.myColor.gray)
                    .margin({ top: 4 })
                }
                .alignItems(HorizontalAlign.Start)
                .layoutWeight(1)

                // VIPæ ‡è¯†
                Stack() {
                  Circle()
                    .width(44)
                    .height(44)
                    .fill('#ffe2decf')

                  Text('ğŸ§')
                    .fontSize(20)
                }
              }
              .width('100%')
              .padding({ left: 20, right: 20, top: 16, bottom: 16 })
              .backgroundColor(this.myColor.bright)
              .borderRadius(16)
              .margin({ left: 16, right: 16, bottom: 8 ,top:8 })

              List({ space: 0 }) {
                ForEach(this.userClicks, (userClick: UserClickModel, index: number) => {
                  ListItem() {
                    this.UserClickItem(index, userClick)
                  }
                })
              }
              .width('100%')
              .layoutWeight(1)
              .scrollBar(BarState.Auto)
              .backgroundColor(this.myColor.background)
            }
            .width('100%')
            .layoutWeight(1)
            .backgroundColor(this.myColor.background)
          } else {
            Column() {
              Stack() {
                Circle()
                  .width(120)
                  .height(120)
                  .fill(this.myColor.bright)
                  .border({
                    width: 2,
                    color: this.myColor.gray,
                    style: BorderStyle.Dashed
                  })

                Text('ğŸµ')
                  .fontSize(48)
              }

              Text('æš‚æ— ä¸ªäººç‚¹å‡»è®°å½•')
                .fontSize(18)
                .fontColor(this.myColor.dark)
                .fontWeight(FontWeight.Medium)
                .margin({ top: 24 })

              Text('å¿«å»å¬æ­Œï¼Œå»ºç«‹å±äºä½ çš„éŸ³ä¹æ¦œå•å§')
                .fontSize(14)
                .fontColor(this.myColor.gray)
                .opacity(0.8)
                .margin({ top: 8 })
                .textAlign(TextAlign.Center)
                .maxLines(2)
            }
            .width('100%')
            .layoutWeight(1)
            .justifyContent(FlexAlign.Center)
            .alignItems(HorizontalAlign.Center)
            .backgroundColor(this.myColor.background)
            .padding({ left: 40, right: 40 })
          }
        }
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor(this.myColor.background)
  }
}